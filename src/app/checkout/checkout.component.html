<div class="checkout-page">
  <h2>Checkout</h2>

  <div *ngIf="isLoggedIn" class="login-section">
    <p>Please log in to proceed with your order.</p>
    <button (click)="login()">Log In</button>
  </div>

  <div *ngIf="isLoggedIn">
    <div class="user-info">
      <h3>Shipping Information</h3>
      <form [formGroup]="checkoutForm">
        <div>
          <label for="name"><strong>Name:</strong></label>
          <input type="text" id="name" class="form-control" formControlName="name" placeholder="name" />
          <div
            *ngIf="checkoutForm.get('name')?.invalid && (checkoutForm.get('name')?.dirty || checkoutForm.get('name')?.touched)"
            class="error-message"
          >
            Name is required.
          </div>
        </div>
        <div>
          <label for="address"><strong>Address:</strong></label>
          <input type="text" id="address" class="form-control" formControlName="address" placeholder="address" />
          <div
            *ngIf="checkoutForm.get('address')?.invalid && (checkoutForm.get('address')?.dirty || checkoutForm.get('address')?.touched)"
            class="error-message"
          >
            Address is required.
          </div>
        </div>
        <div>
          <label for="email"><strong>Email:</strong></label>
          <input type="email" id="email" class="form-control" formControlName="email" placeholder="email" />
          <div
            *ngIf="checkoutForm.get('email')?.invalid && (checkoutForm.get('email')?.dirty || checkoutForm.get('email')?.touched)"
            class="error-message"
          >
            <div *ngIf="checkoutForm.get('email')?.errors?.['required']">Email is required.</div>
            <div *ngIf="checkoutForm.get('email')?.errors?.['email']">Invalid email format.</div>
          </div>
        </div>
      </form>
      <button (click)="logout()">Logout</button>
    </div>

    <h3>Your Cart</h3>
    <div class="cart-items">
      <div *ngIf="isLoadingCart">Loading cart items...</div>
      <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
      <div *ngIf="cartItems.length === 0 && !isLoadingCart && !errorMessage">Your cart is empty.</div>
      <div *ngFor="let item of cartItems" class="cart-item">
        <div class="item-details">
          <span>{{ item.product?.name }}</span>
          <span>Qty: {{ item.quantity }}</span>
        </div>
        <span class="item-price">${{ item.product?.price * item.quantity | number: '1.2-2' }}</span>
        <div class="quantity-controls">
          <button (click)="changeQuantity(item, -1)">-</button>
          <span>{{ item.quantity }}</span>
          <button (click)="changeQuantity(item, 1)">+</button>
        </div>
        <button (click)="removeItem(item)">Remove</button>
      </div>
    </div>

    <div class="order-summary">
      <h3>Order Summary</h3>
      <div *ngIf="isLoadingOrderSummary">Loading order summary...</div>
      <div *ngIf="!isLoadingOrderSummary && !errorMessage && cartItems.length > 0">
        <p><strong>Subtotal:</strong> ${{ total | number: '1.2-2' }}</p>
        <p><strong>Shipping:</strong> $5.00</p>
        <p><strong>Total:</strong> ${{ total + 5 | number: '1.2-2' }}</p>
        <div *ngIf="orderSummary">
          <p><strong>Server Subtotal:</strong> ${{ orderSummary.subtotal | number: '1.2-2' }}</p>
          <p><strong>Server Shipping:</strong> ${{ orderSummary.shippingCost | number: '1.2-2' }}</p>
          <p><strong>Server Total:</strong> ${{ orderSummary.total | number: '1.2-2' }}</p>
        </div>
      </div>
      <div *ngIf="!isLoadingOrderSummary && errorMessage">
        <p class="error-message">Error loading order summary.</p>
      </div>
      <div *ngIf="cartItems.length === 0 && !isLoadingCart && !errorMessage">Your cart is empty.</div>
    </div>

    <button class="place-order-button" (click)="placeOrder()">Place Order</button>
    <div *ngIf="orderPlacedMessage" class="success-message">{{ orderPlacedMessage }}</div>
  </div>
</div>